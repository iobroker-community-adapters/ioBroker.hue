# GitHub Action Template: Initial ioBroker Copilot Setup
# Version: 0.4.0
#
# This action handles the initial setup of GitHub Copilot instructions for ioBroker adapters
# Sourced from: https://raw.githubusercontent.com/DrozmotiX/ioBroker-Copilot-Instructions/main/templates/ghAction-InitialSetup.yml

name: Initial ioBroker Copilot Setup

on:
  workflow_dispatch:  # Manual triggering for initial setup
    inputs:
      force_setup:
        description: 'Force setup even if copilot-instructions.md already exists'
        required: false
        default: 'false'
        type: boolean

jobs:
  initial-setup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check repository structure
        id: repo-check
        run: |
          echo "üîç Analyzing repository structure..."

          # Check if this is an ioBroker adapter
          IOBROKER_ADAPTER="false"
          if [ -f "package.json" ] && grep -q "iobroker" package.json; then
            IOBROKER_ADAPTER="true"
          elif [ -f "io-package.json" ]; then
            IOBROKER_ADAPTER="true"
          fi

          echo "is_iobroker_adapter=$IOBROKER_ADAPTER" >> $GITHUB_OUTPUT

          # Check if copilot instructions already exist
          COPILOT_EXISTS="false"
          if [ -f ".github/copilot-instructions.md" ]; then
            COPILOT_EXISTS="true"
          fi

          echo "copilot_exists=$COPILOT_EXISTS" >> $GITHUB_OUTPUT

          # Extract adapter information
          if [ -f "package.json" ]; then
            ADAPTER_NAME=$(jq -r '.name // "unknown"' package.json)
            DESCRIPTION=$(jq -r '.description // "ioBroker adapter"' package.json)
          else
            ADAPTER_NAME="unknown"
            DESCRIPTION="ioBroker adapter"
          fi

          echo "adapter_name=$ADAPTER_NAME" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT

      - name: Get latest template version
        id: version-check
        run: |
          echo "üåê Fetching latest template version..."
          LATEST_VERSION=$(curl -s https://raw.githubusercontent.com/DrozmotiX/ioBroker-Copilot-Instructions/main/config/metadata.json | jq -r '.version' 2>/dev/null)
          if [ -z "$LATEST_VERSION" ] || [ "$LATEST_VERSION" = "null" ]; then
            echo "‚ùå Failed to fetch latest version from metadata.json"
            exit 1
          fi
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "üìã Latest version: $LATEST_VERSION"

      - name: Create initial copilot instructions
        if: steps.repo-check.outputs.is_iobroker_adapter == 'true' && (steps.repo-check.outputs.copilot_exists == 'false' || github.event.inputs.force_setup == 'true')
        run: |
          echo "üìù Creating initial copilot instructions..."

          # Create .github directory if it doesn't exist
          mkdir -p .github

          # Download latest template
          curl -s -o /tmp/template.md https://raw.githubusercontent.com/DrozmotiX/ioBroker-Copilot-Instructions/main/template.md

          # Remove template comment block and save
          sed '/^<!--$/,/^-->$/d' /tmp/template.md > .github/copilot-instructions.md

          echo "‚úÖ Copilot instructions created from latest template (v${{ steps.version-check.outputs.latest_version }})"

      - name: Commit initial setup
        if: steps.repo-check.outputs.is_iobroker_adapter == 'true' && (steps.repo-check.outputs.copilot_exists == 'false' || github.event.inputs.force_setup == 'true')
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .github/copilot-instructions.md
          git commit -m "feat: initialize ioBroker Copilot instructions with adapter context" || echo "No changes to commit"
          git push

      - name: Create follow-up issue for enhancement
        if: steps.repo-check.outputs.is_iobroker_adapter == 'true' && (steps.repo-check.outputs.copilot_exists == 'false' || github.event.inputs.force_setup == 'true')
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ü§ñ Enhance ioBroker Copilot Instructions';
            const body = `# Automated ioBroker Copilot Template Enhancement

            Initial copilot instructions have been created from the latest template (v${{ steps.version-check.outputs.latest_version }}).
            Now enhance them with adapter-specific content for comprehensive development support.

            **GitHub Copilot**: Please help me customize my ioBroker adapter's Copilot instructions by populating all [CUSTOMIZE] sections with adapter-specific content while preserving the template structure.

            ## Enhancement Process

            1. **Review Existing Context**: Analyze the adapter's purpose from package.json, io-package.json, README.md
            2. **Populate [CUSTOMIZE] Sections**: Add adapter-specific content only (not duplicating standard template)
            3. **Add Hue-Specific Patterns**: Bridge API, v1/v2 protocols, push notifications, TypeScript types

            ## Expected Outcome

            Enhanced .github/copilot-instructions.md with:
            - ‚úÖ Adapter-specific context (Hue bridge connectivity, Hue API patterns)
            - ‚úÖ Build/test command reference for this adapter
            - ‚úÖ Key source file documentation
            - ‚úÖ Hue-specific error handling patterns
            - ‚úÖ CI/CD integration details

            **Template Version**: ${{ steps.version-check.outputs.latest_version }}
            **Adapter**: ${{ steps.repo-check.outputs.adapter_name }}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['copilot-setup', 'automation', 'enhancement']
            });

      - name: Setup automated version checking
        if: steps.repo-check.outputs.is_iobroker_adapter == 'true'
        run: |
          echo "‚öôÔ∏è Setting up automated version checking workflow..."

          # Create workflows directory if it doesn't exist
          mkdir -p .github/workflows

          # Download the automated version check workflow if it doesn't exist
          if [ ! -f ".github/workflows/check-copilot-template.yml" ]; then
            curl -o .github/workflows/check-copilot-template.yml \
              https://raw.githubusercontent.com/DrozmotiX/ioBroker-Copilot-Instructions/main/templates/ghAction-AutomatedVersionCheckAndUpdate.yml

            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add .github/workflows/check-copilot-template.yml
            git commit -m "feat: add automated copilot template version checking" || echo "No changes to commit"
            git push
          else
            echo "‚úÖ check-copilot-template.yml already exists - skipping"
          fi
